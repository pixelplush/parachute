const e="https://api.pixelplush.dev/v1";let t="Pixel Parachute",a={},o={},r="",s=1920,i=1080,n=.5;function l(e){return Math.floor(Math.random()*Math.floor(e))}window.setupGame=function(e,c,p){if(t=e,a=c,o=p,r=a.path||"",o.clouds=void 0===o.clouds||null===o.clouds?!o.overlay:"true"===o.clouds,n=void 0===o.volume||null===o.volume?0:parseInt(o.volume)/100,s=Math.min(window.innerWidth,1920),i=Math.min(window.innerHeight,1080),o.variations&&!o.didRandom){const e=o.variations.split(","),t=l(e.length),a=`${window.location.protocol}//${window.location.host}/${window.location.pathname.substr(0,window.location.pathname.lastIndexOf("/"))}/${e[t]}${window.location.search}&didRandom=1`;window.location.href=a}},window.WebFontConfig={custom:{families:["Pixeltype"]},active(){!async function(){if(document.hidden)return void document.addEventListener("visibilitychange",()=>{location.reload()},!1);try{const t=(await fetch("https://www.pixelplush.dev/assets/shamelist.txt").then(e=>e.text())).split(",").map(e=>e.trim().toLowerCase());if(o.channel&&t&&t.includes(o.channel.toLowerCase())&&(console.log("This channel has been blocked for violating the PixelPlush Terms of Service."),p=!1),a.requires)try{if(account=await fetch(e+"/accounts",{headers:{Twitch:o.oauth?o.oauth.replace("oauth:",""):void 0}}).then(e=>e.json()),console.log(account),account.error)throw"Login Error";if(!account.owned.includes(a.requires))throw"Item not owned"}catch(e){return void console.log("Auth Validate Failed",e)}o.cpDrop&&(h["Parachute Drop!"]={desc:"Drop into the PixelPlush Parachute Game!",color:"#F2C079",cost:parseInt(o.cpDropCost||50),callback:(e,t,r,s,i)=>{p?(v&&o.hideTilDrop&&(v=!1,q.forEach(e=>e.visible=!0),Array.isArray(k)?(k[C].visible=!0,a.target_animate_on_landed||g()):k.visible=!0,Array.isArray(T)?(T[L].visible=!0,a.target_animate_on_landed||g()):T.visible=!0,E&&(E.visible=!0)),w?x.push({username:i.username,name:e,color:i.userColor||"#ffffff",message:s,emote:i.messageEmotes?Object.keys(i.messageEmotes)[0]:"",emoji:"",extra:i}):Q(i.username,e,i.userColor||"#ffffff",s,a.parachutes[l(a.parachutes.length)],a.petparachutes[l(a.petparachutes.length)],i.messageEmotes?Object.keys(i.messageEmotes)[0]:"","",i)):o.oauth&&ComfyJS.Say("PixelParachute is disabled in this channel for violating the Terms of Service. To re-enable the game, please contact the PixelPlush team on Discord.")}}),o.cpDroplets&&(h["Parachute Droplets"]={desc:"Add bouncing obstacles into the PixelPlush Parachute Game!",color:"#F2C079",cost:parseInt(o.cpDropletsCost||500),cooldown:parseInt(o.cpDropletsCD||5),callback:()=>{if(p)for(let e=0;e<5;e++)H(100);else o.oauth&&ComfyJS.Say("PixelParachute is disabled in this channel for violating the Terms of Service. To re-enable the game, please contact the PixelPlush team on Discord.")}}),o.cpQueue&&(h["Group Parachute"]={desc:"Queue everyone for a group drop in the PixelPlush Parachute Game!",color:"#F2C079",cost:parseInt(o.cpQueueCost||500),cooldown:parseInt(o.cpQueueCD||120),callback:()=>{if(p){if(!w){w=!0,Object.keys(z).forEach(e=>{Unicorn.RemoveBacklay("para_"+e),Unicorn.RemoveBacklay("petpara_"+e),Unicorn.RemoveObject("player_"+e),Unicorn.RemoveObject("pet_"+e),Unicorn.RemoveText("name_"+e),Unicorn.RemoveBacklay("end_"+e),Unicorn.RemoveBacklay("petend_"+e),Unicorn.RemoveText(e+"_points"),delete z[e]}),U.x=-1e3,U.y=-1e3,R=0,j&&clearTimeout(j);const e=6e4;ComfyJS.Say(`/me Parachutes are queued for the next 60 seconds. !${o.command||"drop"} to join!`),setTimeout(()=>{ComfyJS.Say(`/me 30 seconds remaining. !${o.command||"drop"} to join!`)},e-3e4),setTimeout(()=>{ComfyJS.Say("/me 10 seconds. !"+(o.command||"drop"))},e-1e4),setTimeout(()=>{_(x),x.forEach(e=>{Q(e.username,e.name,e.color,e.message,e.selectedPara||a.parachutes[l(a.parachutes.length)],e.selectedPetPara||a.petparachutes[l(a.petparachutes.length)],e.emote,e.emoji,e.extra)}),x=[]},e)}}else o.oauth&&ComfyJS.Say("PixelParachute is disabled in this channel for violating the Terms of Service. To re-enable the game, please contact the PixelPlush team on Discord.")}})}catch(e){console.log(e)}Unicorn.Create("unicorn-display",{width:s,height:i,background:"transparent",init:K,update:Z,channel:o.channel,username:o.oauth?o.channel:void 0,password:o.oauth?o.oauth.replace("oauth:",""):void 0,onCommand:$,onChat:S,screenWalls:!1,gravity:{x:0,y:1}}),ComfyJS.onCheer=A,ComfyJS.onConnected=async(e,t,r)=>{if(r){!function(){O=a.target_width||368,P=O/2+l(s-O),I=i-47+(a.target_offset||0),a.target_walls&&(P<O/2+70?P=O/2+70:P>s-O/2-70&&(P=s-O/2-70));if(a.target_versions){const e=l(Object.keys(a.target_versions).length);Object.keys(a.target_versions).forEach((t,r)=>{e===r&&(D=t);let s=a.target_versions[t];if(M[t]={},Array.isArray(s.target))if(a.target_random){let e=l(s.target.length);k=Unicorn.AddBacklay("target"+t+e,"target"+t+e,P,I,{scale:{x:2,y:2}}),k.zIndex=10,k.anchor.set(.5),k.visible=!1,M[t].target=k}else{C=0,k=[];for(let e=0;e<s.target.length;e++){let a=Unicorn.AddBacklay("target"+t+e,"target"+t+e,P,I,{scale:{x:2,y:2}});a.zIndex=10,a.anchor.set(.5),a.visible=!1,k.push(a)}M[t].target=k,k[C].visible=!1,o.hideTilDrop||a.target_animate_on_landed||g()}else k=Unicorn.AddBacklay("target"+t,"target"+t,P,I,{scale:{x:2,y:2}}),k.zIndex=10,k.anchor.set(.5),k.visible=!1,M[t].target=k;if(s.target_overlay)if(Array.isArray(s.target_overlay)){L=0,T=[];for(let e=0;e<s.target_overlay.length;e++){let a=Unicorn.AddBacklay("target_overlay"+t+e,"target_overlay"+t+e,P,I,{scale:{x:2,y:2}});a.zIndex=11,a.anchor.set(.5),a.visible=!1,T.push(a)}M[t].target_overlay=T,T[L].visible=!1,o.hideTilDrop||a.target_animate_on_landed||g()}else T=Unicorn.AddBacklay("target_overlay"+t,"target_overlay"+t,P,I,{scale:{x:2,y:2}}),T.zIndex=11,T.anchor.set(.5),T.visible=!1,M[t].target_overlay=T})}else{if(Array.isArray(a.target))if(a.target_random){let e=l(a.target.length);k=Unicorn.AddBacklay("target"+e,"target"+e,P,I,{scale:{x:2,y:2}}),k.zIndex=10,k.anchor.set(.5)}else{C=0,k=[];for(let e=0;e<a.target.length;e++){let t=Unicorn.AddBacklay("target"+e,"target"+e,P,I,{scale:{x:2,y:2}});t.zIndex=10,t.anchor.set(.5),t.visible=!1,k.push(t)}k[C].visible=!0,o.hideTilDrop||a.target_animate_on_landed||g()}else k=Unicorn.AddBacklay("target","target",P,I,{scale:{x:2,y:2}}),k.zIndex=10,k.anchor.set(.5);if(a.target_overlay)if(Array.isArray(a.target_overlay)){L=0,T=[];for(let e=0;e<a.target_overlay.length;e++){let t=Unicorn.AddBacklay("target_overlay"+e,"target_overlay"+e,P,I,{scale:{x:2,y:2}});t.zIndex=11,t.anchor.set(.5),t.visible=!1,T.push(t)}T[L].visible=!0,o.hideTilDrop||a.target_animate_on_landed||g()}else T=Unicorn.AddBacklay("target_overlay","target_overlay",P,I,{scale:{x:2,y:2}}),T.zIndex=11,T.anchor.set(.5)}a.target_front&&(E=Unicorn.AddOverlay("target_front","target_front",P,I,{scale:{x:2,y:2}}),E.anchor.set(.5));if(o.clouds)for(let e=0;e<11;e++){b++;let e=a.clouds[l(a.clouds.length)],t=Unicorn.AddOverlay("cloud_"+b,e,l(s),l(500),{scale:{x:3,y:3}});t.alpha=o.overlay?.5:.9,t.anchor.set(.5),t.speed=.01+.1*Math.random(),t.zIndex=t.speed,q.push(t)}o.hideTilDrop&&(q.forEach(e=>e.visible=!1),Array.isArray(a.target)&&!a.target_random?k.forEach(e=>{e.visible=!1}):k.visible=!1,T&&(Array.isArray(a.target_overlay)&&!a.target_random?T.forEach(e=>{e.visible=!1}):T.visible=!1),E&&(E.visible=!1));a.target_walls&&(Unicorn.AddObject("TargetTop",{type:"rectangle",x:P,y:I+a.target_walls/2+a.target_collide_land,width:O-50,height:10,isStatic:!0}).sprite.visible=!1,Unicorn.AddObject("TargetLeft",{type:"rectangle",x:P-O/2+27,y:I+a.target_walls,width:10,height:100,isStatic:!0}).sprite.visible=!1,Unicorn.AddObject("TargetRight",{type:"rectangle",x:P+O/2-27,y:I+a.target_walls,width:10,height:100,isStatic:!0}).sprite.visible=!1)}();let e=await f();if(0!==e&&(c=e.session,setInterval(()=>{f()},6e4)),o.oauth){let e=await async function(e){return await fetch("https://id.twitch.tv/oauth2/validate",{headers:{Authorization:"OAuth "+e}}).then(e=>e.json()).catch(e=>({error:e}))}(o.oauth.replace("oauth:",""));d=e.client_id,["user:read:email","chat:read","chat:edit","channel:manage:redemptions","channel:read:redemptions"].every(t=>e.scopes.includes(t))||console.log("Need more permissions"),e.expires_in<1800&&console.log("Token expires soon. Need to generate new link")}let t=await ComfyJS.GetChannelRewards(d,!0),r=Object.keys(h);for(let e=0;e<r.length;e++){let a=r[e];if(!t.some(e=>e.title===a))try{await ComfyJS.CreateChannelReward(d,{title:a,prompt:h[a].desc,cost:h[a].cost,is_enabled:!0,background_color:h[a].color,is_user_input_required:!1,is_max_per_stream_enabled:!1,max_per_stream:0,is_max_per_user_per_stream_enabled:!1,max_per_user_per_stream:0,is_global_cooldown_enabled:!!h[a].cooldown,global_cooldown_seconds:h[a].cooldown,should_redemptions_skip_request_queue:!0})}catch(e){console.log(e)}}}},ComfyJS.onReward=(e,t,a,o,r)=>{h[t]&&h[t].callback(e,t,a,o,r)}}()}},function(){const e=document.createElement("script");e.src=("https:"===document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js",e.type="text/javascript",e.async="true";const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();var c="",p=!0;let d="";const h={};async function f(){let a=Object.keys(z).length;return fetch(e+"/analytics/heartbeat",{method:"POST",body:JSON.stringify({session:c,game:"parachute",theme:t,channel:o.channel,players:Object.keys(z),count:a})}).then(e=>e.json())}async function y(a,r,s,i){return o.oauth?fetch(e+"/scores/add",{method:"POST",body:JSON.stringify({token:o.oauth.replace("oauth:",""),channel:o.channel,game:"parachute",theme:t,user:a,score:r,userId:s,username:i})}).then(e=>e.json()):{}}let m=null,u=0;function g(e=0){if(m&&clearInterval(m),a.target_versions){Object.keys(M).forEach(e=>{Array.isArray(k)?M[e].target.forEach(e=>{e.visible=!1}):M[e].target.visible=!1,M[e].target_overlay.forEach(e=>{e.visible=!1})});const e=l(Object.keys(M).length);D=Object.keys(M)[e],k=M[D].target,T=M[D].target_overlay,Array.isArray(k)?k[C].visible=!0:k.visible=!0,T[L].visible=!0}m=setInterval(()=>{Array.isArray(k)&&(k[C].visible=!1,C=(C+1)%k.length,k[C].visible=!0),T&&Array.isArray(T)&&(T[L].visible=!1,L=(L+1)%T.length,T[L].visible=!0)},60),e>0&&(u=1e3*e)}function _(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}}let b=0,v=!0,x=[],w=!1;async function $(t,r,s,i,n){if(document.hidden)return;if((i.broadcaster||i.mod)&&("resetparachute"===r||"resetdrop"===r))if(o.variations){const e=o.variations.split(","),t=l(e.length),a=`${window.location.protocol}//${window.location.host}${window.location.pathname.substr(0,window.location.pathname.lastIndexOf("/"))}/${e[t]}${window.location.search}`;window.location.href=a}else location.reload();if((i.broadcaster||i.mod)&&("deleteparachute"===r||"deletedrop"===r)){let e=await ComfyJS.GetChannelRewards(d,!0),t=Object.keys(h);for(let a=0;a<t.length;a++){let o=t[a],r=e.find(e=>e.title===o);r&&await ComfyJS.DeleteChannelReward(d,r.id)}}if((i.broadcaster||i.mod)&&"queuedrop"===r&&(w=!w,Object.keys(z).forEach(e=>{Unicorn.RemoveBacklay("para_"+e),Unicorn.RemoveBacklay("petpara_"+e),Unicorn.RemoveObject("player_"+e),Unicorn.RemoveObject("pet_"+e),Unicorn.RemoveText("name_"+e),Unicorn.RemoveBacklay("end_"+e),Unicorn.RemoveBacklay("petend_"+e),Unicorn.RemoveText(e+"_points"),delete z[e]}),U.x=-1e3,U.y=-1e3,R=0,j&&clearTimeout(j),w?ComfyJS.Say("/me Drops are queued this game. !startdrop to activate!"):ComfyJS.Say("/me Drops are no longer queued.")),(i.broadcaster||i.mod)&&"startdrop"===r&&w&&(_(x),x.forEach(e=>{Q(e.username,e.name,e.color,e.message,e.selectedPara||a.parachutes[l(a.parachutes.length)],e.selectedPetPara||a.petparachutes[l(a.petparachutes.length)],e.emote,e.emoji,e.extra)}),x=[]),(i.broadcaster||i.mod)&&"testdrop"===r)for(var c=0;c<50;c++)b++,Q("test_"+b,"test_"+b,n.userColor||"#ffffff",Object.keys(a.characters)[l(Object.keys(a.characters).length)],a.parachutes[l(a.parachutes.length)],a.petparachutes[l(a.petparachutes.length)],"","",n);if((i.broadcaster||i.mod)&&"droplet"===r){let e=parseInt(s||Math.pow(10,l(6)));for(let t=0;t<5;t++)H(e)}if(("drophigh"===r||"drophighscore"===r||"dropbest"===r)&&o.oauth){let t=await async function(){if(o.oauth){const t=new Date;t.setDate(t.getDate()-1);const a=t.toISOString().split("T")[0];return(await fetch(`${e}/scores/high?channel=${o.channel}&game=parachute&date=${a}`,{method:"GET"}).then(e=>e.json()))[0]}return null}();t&&t.score&&ComfyJS.Say(`/me The highest score in the past 24 hours is ${t.score} by ${t.user}`)}if(("droplow"===r||"droplowscore"===r||"dropworst"===r)&&o.oauth){let t=await async function(){if(o.oauth){const t=new Date;t.setDate(t.getDate()-1);const a=t.toISOString().split("T")[0];return(await fetch(`${e}/scores/low?channel=${o.channel}&game=parachute&date=${a}`,{method:"GET"}).then(e=>e.json()))[0]}return null}();t&&t.score&&ComfyJS.Say(`/me The lowest score in the past 24 hours is ${t.score} by ${t.user}`)}if(("droptop"===r||"droptopscores"===r||"dropleaderboard"===r||"dropscores"===r)&&o.oauth){let t=await async function(){if(o.oauth){const t=new Date;t.setDate(t.getDate()-1);const a=t.toISOString().split("T")[0];return await fetch(`${e}/scores/high?channel=${o.channel}&game=parachute&date=${a}`,{method:"GET"}).then(e=>e.json())}return[]}();if(t&&t.length>0){let e=Array.from(new Set(t.map(e=>e.userId))).slice(0,10).map(e=>t.find(t=>t.userId===e));ComfyJS.Say("/me Top players in the past 24 hours are "+e.map((e,t)=>`${t+1}. ${e.user} (${e.score})`).join(", "))}else ComfyJS.Say("/me There are no scores recorded in the past 24 hours")}if("droprecent"===r&&o.oauth){let t=await async function(){if(o.oauth){return await fetch(`${e}/scores/recent?channel=${o.channel}&game=parachute`,{method:"GET"}).then(e=>e.json())}return[]}();if(t&&t.length>0){let e=Array.from(new Set(t.map(e=>e.userId))).slice(0,10).map(e=>t.find(t=>t.userId===e));ComfyJS.Say("/me Latest scores are "+e.map((e,t)=>`${e.user} (${e.score})`).join(", "))}else ComfyJS.Say("/me There are no recent scores")}let f=!1;if(!o.commandOn&&o.cpDrop||!o.command||r!==o.command||(f=!0),!o.commandOn&&o.cpDrop||o.command||"drop"!==r||(f=!0),p){if(f){v&&o.hideTilDrop&&(v=!1,q.forEach(e=>e.visible=!0),Array.isArray(k)?(k[C].visible=!0,a.target_animate_on_landed||g()):k.visible=!0,T&&(Array.isArray(T)?(T[L].visible=!0,a.target_animate_on_landed||g()):T.visible=!0),E&&(E.visible=!0));const e=twemoji.parse(s,{assetType:"png"});if(!n.messageEmotes&&e.length>0)w?x.push({username:n.username,name:t,color:n.userColor||"#ffffff",message:s,emote:"",emoji:e[0].url,extra:n}):Q(n.username,t,n.userColor||"#ffffff",s,a.parachutes[l(a.parachutes.length)],a.petparachutes[l(a.petparachutes.length)],"",e[0].url,n);else if(a.pridechutes){const e=Object.keys(a.pridechutes),o=n.messageEmotes?Object.keys(n.messageEmotes):[],i=o.map(e=>{const t=n.messageEmotes[e][0].split("-").map(e=>parseInt(e));return`!${r} ${s}`.substring(t[0],t[1]+1)}),c=i.filter(e=>e.toLowerCase().includes("pride"));let p=e.find(e=>c.some(t=>t.toLowerCase().includes(e)));if(p){const e=a.pridechutes[p];let r=o.find((e,t)=>!i[t].toLowerCase().includes(p));w?x.push({username:n.username,name:t,color:n.userColor||"#ffffff",message:s,selectedPara:e,selectedPetPara:e,emote:r,emoji:"",extra:n}):Q(n.username,t,n.userColor||"#ffffff",s,e,e,r,"",n)}else w?x.push({username:n.username,name:t,color:n.userColor||"#ffffff",message:s,emote:n.messageEmotes?Object.keys(n.messageEmotes)[0]:"",emoji:"",extra:n}):Q(n.username,t,n.userColor||"#ffffff",s,a.parachutes[l(a.parachutes.length)],a.petparachutes[l(a.petparachutes.length)],n.messageEmotes?Object.keys(n.messageEmotes)[0]:"","",n)}else w?x.push({username:n.username,name:t,color:n.userColor||"#ffffff",message:s,emote:n.messageEmotes?Object.keys(n.messageEmotes)[0]:"",emoji:"",extra:n}):Q(n.username,t,n.userColor||"#ffffff",s,a.parachutes[l(a.parachutes.length)],a.petparachutes[l(a.petparachutes.length)],n.messageEmotes?Object.keys(n.messageEmotes)[0]:"","",n)}}else f&&o.oauth&&ComfyJS.Say("PixelParachute is disabled in this channel for violating the Terms of Service. To re-enable the game, please contact the PixelPlush team on Discord.")}function S(e,t,a,o,r){document.hidden}function A(e,t,a,o,r){if(!document.hidden&&p)for(let e=0;e<5;e++)H(t)}let U,j=null,O=368,P=0,I=0,k=null,T=null,E=null,C=0,L=0,M={},D=null,z={},R=0,B="",J={},F={},q=[],G=[],N=[],W=0;function Y(e,t,a,o,r,s=""){W++;let i=Math.min(Math.max(1,r),100);Unicorn.AddParticles("Splash_"+W,{blendMode:PIXI.BLEND_MODES.DEFAULT,shape:"cone",angle:-Math.PI/2,spread:Math.PI/2,startColor:e,endColor:t,intensity:i,minSpeed:.05,maxSpeed:.25,gravityX:0,gravityY:3.5,fadeOut:!0,decay:1,image:s||void 0},a,o),function(e,t=2e3){setTimeout(()=>{Unicorn.RemoveParticles(e)},t)}("Splash_"+W,150)}function X(e,t,o,r=""){const s=a.target_boosh_scale||2;a.target_boosh.forEach((a,o)=>{for(let a=0;a<l(5);a++){W++;let o=Unicorn.AddBacklay("boosh_"+W,"target_boosh"+a,e,t+10,{scale:{x:s,y:s}});o.zIndex=11,o.vX=l(50)-25,o.vY=-350+l(100),o.anchor.set(.5),G.push(o)}})}function V(e,t,o,r=""){const s=a.target_splash_scale||2;a.target_splash.forEach((a,o)=>{for(let a=0;a<l(5);a++){W++;let o=Unicorn.AddBacklay("splash_"+W,"target_splash"+a,e,t+10,{scale:{x:s,y:s}});o.zIndex=11,o.vX=l(100)-50,o.vY=-300+l(100),o.anchor.set(.5),N.push(o)}})}async function Q(t,i,c="#ffffff",p,d,h,f="",y="",m){let u=4/60;if(!z[t]){let _=!1;0,z[t]={};let b=null,v=null,x=null,w=tinycolor(c),$={};try{let a=await fetch(`${e}/accounts/twitch/design?username=${t}`).then(e=>e.json());a&&($=a.style||{})}catch(e){console.log(e)}if($.pet&&$.pet.id&&"pet_none"!==$.pet.id&&(a.pets||(a.pets={}),v=$.pet.id.replace("pet_",""),!a.pets[v])){a.pets[v]={path:$.pet.path,minIdle:$.pet.minIdle,maxIdle:$.pet.maxIdle};for(let e=0;e<10;e++){let t=$.pet.path+"_front";Unicorn.Load(t+e,`${r}/assets/pets/${v}/${t}/${t}${e+1}.png`)}}if(f){if(!J[f]){if(J[f]=!0,f.startsWith("emotesv2_")){let e=`https://static-cdn.jtvnw.net/emoticons/v2/${f}/default/dark/2.0`,a=await fetchGif(e);if(a.length>0){const e=Math.min(...a.map(e=>e.delay)),o=Math.max(...a.map(e=>e.dims.width)),r=Math.max(...a.map(e=>e.dims.height)),s=o;let n=0;for(let t=0;t<a.length;t++){let i=document.createElement("canvas");i.width=o,i.height=r;let l=i.getContext("2d"),c=l.createImageData(o,r);if(1===a[t].disposalType){let e=t;for(let t=a[e].dims.top;t<r;t++)for(let r=a[e].dims.left;r<o;r++)t>=a[e].dims.top&&r>=a[e].dims.left&&t<a[e].dims.top+a[e].dims.height&&r<a[e].dims.left+a[e].dims.width&&a[e].pixels[t*s+r]!==a[e].transparentIndex?(c.data[t*s*4+4*r+0]=a[e].patch[t*s*4+4*r+0],c.data[t*s*4+4*r+1]=a[e].patch[t*s*4+4*r+1],c.data[t*s*4+4*r+2]=a[e].patch[t*s*4+4*r+2],c.data[t*s*4+4*r+3]=a[e].patch[t*s*4+4*r+3]):0===e&&(c.data[t*s*4+4*r+0]=a[0].patch[t*s*4+4*r+0],c.data[t*s*4+4*r+1]=a[0].patch[t*s*4+4*r+1],c.data[t*s*4+4*r+2]=a[0].patch[t*s*4+4*r+2],c.data[t*s*4+4*r+3]=a[0].patch[t*s*4+4*r+3])}else if(3===a[t].disposalType){let e=null;for(let i=0;i<=t;i++){for(let e=0;e<r;e++)for(let t=0;t<o;t++)if(e>=a[i].dims.top&&t>=a[i].dims.left&&e<a[i].dims.top+a[i].dims.height&&t<a[i].dims.left+a[i].dims.width){const o=(e-a[i].dims.top)*a[i].dims.width+(t-a[i].dims.left),r=(e-a[i].dims.top)*a[i].dims.width*4+4*(t-a[i].dims.left);a[i].pixels[o]!==a[i].transparentIndex?(c.data[e*s*4+4*t+0]=a[i].patch[r+0],c.data[e*s*4+4*t+1]=a[i].patch[r+1],c.data[e*s*4+4*t+2]=a[i].patch[r+2],c.data[e*s*4+4*t+3]=a[i].patch[r+3]):(c.data[e*s*4+4*t+0]=0,c.data[e*s*4+4*t+1]=0,c.data[e*s*4+4*t+2]=0,c.data[e*s*4+4*t+3]=0)}0===i&&(e=c.data.slice())}}else{let e=t;for(let t=a[e].dims.top;t<r;t++)for(let r=a[e].dims.left;r<o;r++){const o=(t-a[e].dims.top)*a[e].dims.width+(r-a[e].dims.left),i=(t-a[e].dims.top)*a[e].dims.width*4+4*(r-a[e].dims.left);t>=a[e].dims.top&&r>=a[e].dims.left&&t<a[e].dims.top+a[e].dims.height&&r<a[e].dims.left+a[e].dims.width&&a[e].pixels[o]!==a[e].transparentIndex&&(c.data[t*s*4+4*r+0]=a[e].patch[i+0],c.data[t*s*4+4*r+1]=a[e].patch[i+1],c.data[t*s*4+4*r+2]=a[e].patch[i+2],c.data[t*s*4+4*r+3]=a[e].patch[i+3])}}l.putImageData(c,0,0);for(let s=0;s<a[t].delay;s+=e)Unicorn.LoadCustom(`emote_${f}${n}`,i,"texture",{width:o,height:r}),n++}J[f]={frames:n,framerate:1/60*(1e3/e)},setTimeout(()=>{delete z[t],Q(t,i,c,p,d,h,f,y,m)},500)}else Unicorn.Load("emote_"+f,e),setTimeout(()=>{delete z[t],Q(t,i,c,p,d,h,f,y,m)},500)}else{let e=`https://static-cdn.jtvnw.net/emoticons/v1/${f}/2.0`;Unicorn.Load("emote_"+f,e),setTimeout(()=>{delete z[t],Q(t,i,c,p,d,h,f,y,m)},500)}return}let e=[];if(f.startsWith("emotesv2_")&&"boolean"!=typeof J[f]){u=J[f].framerate;for(let t=0;t<J[f].frames;t++)e.push(`emote_${f}${t}`)}else e=["emote_"+f];b=_?Unicorn.AddObject(t,{type:"circle",scale:{x:1.2,y:1.2},friction:0,frictionAir:0,frictionStatic:0,bounce:1,animations:{front:{framerate:u,frames:e,loop:!0}},x:P,y:-100-l(50),z:100,radius:.1}):Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:1.2,y:1.2},friction:0,frictionAir:0,frictionStatic:0,bounce:1,animations:{front:{framerate:u,frames:e,loop:!0}},x:l(s),y:-100-l(50),z:100,radius:36}),b.endImage=e[0],b.endScale=1.2}else if(y){if(!F[y])return F[y]=!0,Unicorn.Load("emoji_"+y,y),void setTimeout(()=>{delete z[t],Q(t,i,c,p,d,h,f,y,m)},500);b=_?Unicorn.AddObject(t,{type:"circle",scale:{x:1,y:1},friction:0,frictionAir:0,frictionStatic:0,bounce:1,animations:{front:{framerate:u,frames:["emoji_"+y],loop:!0}},x:P,y:-100-l(50),z:100,radius:.1}):Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:1,y:1},friction:0,frictionAir:0,frictionStatic:0,bounce:1,animations:{front:{framerate:u,frames:["emoji_"+y],loop:!0}},x:l(s),y:-100-l(50),z:100,radius:36}),b.endImage="emoji_"+y,b.endScale=1}else{if(!a.characters[p])if($.character&&$.character.id){if(!a.characters[$.character.id]){a.characters[$.character.id]=$.character.path;for(let e=0;e<10;e++){let t=a.characters[$.character.id];Unicorn.Load(`${$.character.id}_${e}`,`${r}/assets/characters/${$.character.id}/${t}_front/${t}_front${e+1}.png`)}}p=$.character.id}else p=a.playable[Math.floor(a.playable.length*Math.random())];if(b=_?Unicorn.AddObject(t,{type:"circle",scale:{x:3,y:3},friction:0,frictionAir:0,frictionStatic:0,bounce:1,animations:{front:{framerate:u,frames:[...Array(10).keys()].map(e=>`${p}_${e}`),loop:!0}},x:P,y:-100-l(50),z:100,radius:.1}):Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:3,y:3},friction:0,frictionAir:0,frictionStatic:0,bounce:1,animations:{front:{framerate:u,frames:[...Array(10).keys()].map(e=>`${p}_${e}`),loop:!0}},x:l(s),y:-100-l(50),z:100,radius:36}),b.endImage=p+"_0",b.endScale=3,"boybear"===p||"girlbear"===p){var g=PIXI.utils.string2hex(w.brighten(50).toHexString());b.animations.front.tint=g}}if(v){let e={front:[]};for(let t=0;t<10;t++)Object.keys(e).forEach(o=>{e[o].push(a.pets[v].path+"_"+o+t)});x=Unicorn.AddObject("pet_"+t,{type:"circle",scale:{x:3,y:3},animations:{front:{framerate:4/60,frames:e.front,loop:!0}},x:-1e3,y:-1e3,z:200,radius:24,isStatic:!0}),x.isSensor=!0}let S=Unicorn.AddBacklay("para_"+t,d,{scale:{x:0,y:0},x:-50,y:0,z:50});S.visible=!1,S.zIndex=11,S.scale.x=0,S.scale.y=0,S.anchor.set(.5,1);let A=Unicorn.AddText("name_"+t,i,-1e3,-1e3,{fontFamily:"Pixeltype",fontSize:40,fontWeight:"bold",fill:c,lineJoin:"round",stroke:w.getLuminance()<.6?"#ffffff":"#000000",strokeThickness:6});A.anchor.set(.5);let U=Unicorn.AddText(t+"_points","",-1e3,-1e3,{fontFamily:"Pixeltype",fontSize:40,fontWeight:"bold",fill:"#ffd700",lineJoin:"round",stroke:"#000000",strokeThickness:6});U.anchor.set(.5);let O=null;v&&(O=Unicorn.AddBacklay("petpara_"+t,h||d,{scale:{x:0,y:0},x:-50,y:0,z:150}),O.visible=!1,O.zIndex=11,O.scale.x=0,O.scale.y=0,O.anchor.set(.5,1)),b.restitution=1,_?(b.friction=0,b.frictionStatic=0,b.frictionAir=0,b.torque=0,b.rotationOffset=0,Unicorn.SetVelocity(t,0,0)):(b.friction=0,b.frictionStatic=0,b.frictionAir=0,b.torque=-5+l(10),b.rotationOffset=Math.random()*Math.PI,Unicorn.SetVelocity("player_"+t,l(24)-12,0)),z[t]={parachute:S,player:b,pet:x,petPara:O,petType:v,petOffset:30*Math.random()+(Math.random()>.5?-150:70),label:A,scoreLabel:U},m&&(z[t].userId=m.userId,z[t].name=m.displayName||m.username),d&&d.includes("chute_plane")&&(z[t].paraFlipDir=!0),h&&h.includes("chute_plane")&&(z[t].petParaFlipDir=!0),Unicorn.PlaySound("sfx-parachute-drop",{volume:n}),j&&clearTimeout(j),j=setTimeout(()=>{if(o.variations){const e=o.variations.split(","),t=l(e.length),a=`${window.location.protocol}//${window.location.host}/${window.location.pathname.substr(0,window.location.pathname.lastIndexOf("/"))}/${e[t]}${window.location.search}`;window.location.href=a}else location.reload()},parseInt(o.cooldown||"90000"))}}async function H(e){if(!o.droplets)return;W++;let t=null,r=0;r=l(6);let i=3;a.dropletSizes&&(i*=a.dropletSizes[r]);let n=a.droplets[r];Array.isArray(a.droplets[r])&&(n=a.droplets[r][l(a.droplets[r].length)]),t=Unicorn.AddObject("droplet_"+W,{type:"circle",sprite:n,scale:{x:i,y:i},x:l(s),y:-100-l(50),z:100,radius:r/5*4+20}),t.restitution=1,t.friction=.5*(5-r),t.frictionStatic=0,t.frictionAir=0,t.torque=-1+l(2),t.rotationOffset=Math.random()*Math.PI,Unicorn.SetVelocity("droplet_"+W,l(24)-12,0),setTimeout(()=>{Unicorn.RemoveObject(t.label)},3e4)}function K(){if(PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,Unicorn.Load("map",`${r}/assets/${a.bg}.png`),!o.overlay){var e=Unicorn.AddBacklay("map","map",0,i-1080);e.scale.x=3,e.scale.y=3}if(a.target_versions)Object.keys(a.target_versions).forEach(e=>{let t=a.target_versions[e];if(Array.isArray(t.target)){t.target.map((t,a)=>Unicorn.Load("target"+e+a,`${r}/assets/${t}.png`))}else{Unicorn.Load("target"+e,`${r}/assets/${t.target}.png`)}if(Array.isArray(t.target_overlay)){t.target_overlay.map((t,a)=>Unicorn.Load("target_overlay"+e+a,`${r}/assets/${t}.png`))}else{Unicorn.Load("target_overlay"+e,`${r}/assets/${t.target_overlay}.png`)}if(t.target_effect){t.target_effect.map((t,a)=>Unicorn.Load("target_effect"+e+a,`${r}/assets/${t}.png`))}});else{if(Array.isArray(a.target)){a.target.map((e,t)=>Unicorn.Load("target"+t,`${r}/assets/${e}.png`))}else{Unicorn.Load("target",`${r}/assets/${a.target}.png`)}if(Array.isArray(a.target_overlay)){a.target_overlay.map((e,t)=>Unicorn.Load("target_overlay"+t,`${r}/assets/${e}.png`))}else{Unicorn.Load("target_overlay",`${r}/assets/${a.target_overlay}.png`)}if(a.target_effect){a.target_effect.map((e,t)=>Unicorn.Load("target_effect"+t,`${r}/assets/${e}.png`))}}a.target_front&&Unicorn.Load("target_front",`${r}/assets/${a.target_front}.png`),a.target_boosh&&a.target_boosh.forEach((e,t)=>{Unicorn.Load("target_boosh"+t,`${r}/assets/${e}.png`)}),a.target_splash&&a.target_splash.forEach((e,t)=>{Unicorn.Load("target_splash"+t,`${r}/assets/${e}.png`)}),Unicorn.Load("star",r+"/assets/icons/star.png"),U=Unicorn.AddOverlay("star","star",-1e3,-1e3,{scale:{x:3,y:3}}),U.anchor.set(.5),a.parachutes.forEach(e=>Unicorn.Load(e,`${r}/assets/${e}.png`)),a.petparachutes?a.petparachutes.forEach(e=>Unicorn.Load(e,`${r}/assets/${e}.png`)):a.petparachutes=[],a.pridechutes&&Object.keys(a.pridechutes).forEach(e=>Unicorn.Load(a.pridechutes[e],`${r}/assets/${a.pridechutes[e]}.png`)),Object.keys(a.characters).forEach(e=>{for(let t=0;t<10;t++){let o=a.characters[e];Unicorn.Load(`${e}_${t}`,`${r}/assets/characters/${e}/${o}_front/${o}_front${t+1}.png`)}}),a.clouds.forEach(e=>Unicorn.Load(e,`${r}/assets/${e}.png`)),a.droplets.forEach(e=>{Array.isArray(e)?e.forEach(e=>Unicorn.Load(e,`${r}/assets/${e}.png`)):Unicorn.Load(e,`${r}/assets/${e}.png`)}),a.target_sound&&Unicorn.Load("sfx-target-drop",`${r}/assets/${a.target_sound}`),Unicorn.Load("sfx-parachute-drop",`${r}/assets/${a.drop_sound}`),Unicorn.Load("sfx-parachute-flap",`${r}/assets/${a.parachute_sound}`),Unicorn.AddObject("WallLeft",{type:"rectangle",x:-200,y:0,width:400,height:2*i,friction:0,frictionAir:0,frictionStatic:0,bounce:1,isStatic:!0}).sprite.visible=!1,Unicorn.AddObject("WallRight",{type:"rectangle",x:s+200,y:0,width:400,height:2*i,friction:0,frictionAir:0,frictionStatic:0,bounce:1,isStatic:!0}).sprite.visible=!1,Unicorn.AddObject("WallBottom",{type:"rectangle",x:.5*s,y:i+100,friction:0,frictionAir:0,frictionStatic:0,bounce:1,width:s,height:200,isStatic:!0}).sprite.visible=!1,Matter.Events.on(physics,"beforeUpdate",(function(e){const t=Object.keys(z);for(let e=0;e<t.length;e++){const a=t[e],o=z[a];o.player&&(o.player.position.y<.5*-i?o.player.velocity.y>10&&Matter.Body.setVelocity(o.player,{x:o.player.velocity.x,y:10}):o.player.position.y>300&&o.player.velocity.y>.5&&Matter.Body.setVelocity(o.player,{x:o.player.velocity.x,y:.5}))}})),Matter.Events.on(physics,"afterUpdate",(function(e){const t=Object.keys(z);for(let e=0;e<t.length;e++){const o=t[e],r=z[o];if(r.pet){let e=Math.min(3,Math.max(0,.3*(r.player.position.y-300)));r.petPara.scale.x=r.petPara.scale.y=e/2,r.petParaFlipDir&&r.player.velocity.x>0&&(r.petPara.scale.x=-e/2),r.pet.angle=r.player.angle,r.pet.position.x=Math.max(20,Math.min(s-20,r.player.position.x+r.petOffset)),r.pet.position.y=Math.min(r.player.position.y+20,i-46-50+(a.target_y_offset||0)),r.petPara.rotation=r.player.angle,r.petPara.position.x=r.pet.position.x,r.petPara.position.y=r.pet.position.y}}}))}function Z(e,t){const r=Object.keys(z);for(let t=0;t<r.length;t++){const l=r[t],c=z[l];if(c.player)if(c.isLanded){let e=l===B?1:.3;c.end.alpha=e,c.label.alpha=Math.round(e),c.pet&&(c.petEnd.alpha=e),c.scoreLabel.tint=c.label.tint=l===B?16777215:3355443,l===B?(c.end.zIndex=c.scoreLabel.zIndex=c.label.zIndex=9e3,c.pet&&(c.pet.zIndex=9001),c.label.position.x=c.player.position.x,c.label.position.y=c.player.position.y-80,c.scoreLabel.position.x=c.label.position.x+15,c.scoreLabel.position.y=c.label.position.y-30,c.label.style.fontSize=46,c.scoreLabel.style.fontSize=46,U.x=c.scoreLabel.x-c.scoreLabel.width/2-15,U.y=c.scoreLabel.y-5):(c.label.position.x=c.player.position.x,c.label.position.y=c.player.position.y-60,c.scoreLabel.position.y=c.label.position.y-30,c.scoreLabel.alpha=0,c.label.style.fontSize=40,c.scoreLabel.style.fontSize=40)}else{if(c.pet&&(c.pet.position.x=Math.max(20,Math.min(s-20,c.player.position.x+c.petOffset)),c.pet.position.y=Math.min(c.player.position.y+20,i-46-50+(a.target_y_offset||0)),c.petPara.position.x=c.pet.position.x,c.petPara.position.y=c.pet.position.y),c.player.position.y>i-46-50+(a.target_y_offset||0)||a.target_walls&&c.player.position.y>i-46-50+(a.target_collide_land||0)&&O/2-20>Math.abs(P-c.player.position.x)){c.isLanded=!0,c.parachute.scale.x=c.parachute.scale.y=0,c.pet&&(c.petPara.scale.x=c.petPara.scale.y=0);let e=Unicorn.AddBacklay("end_"+l,c.player.endImage,c.player.position.x,c.player.position.y,{scale:{x:c.player.endScale,y:c.player.endScale}});if(c.player.animations&&(e.tint=c.player.animations.front.tint),e.anchor.set(.5),e.zIndex=20,c.player.isStatic=!0,a.target_walls?c.score=100*Math.max(0,O/2-20-Math.abs(P-c.player.position.x))/(O/2-20):c.score=100*Math.max(0,O/2-Math.abs(P-c.player.position.x))/(O/2),e.alpha=c.score>0?1:.3,c.end=e,c.pet){let e=Unicorn.AddBacklay("petend_"+l,c.petType+"_front0",c.pet.position.x,c.pet.position.y,{scale:{x:3,y:3}});c.pet.animations&&(e.tint=c.pet.animations.front.tint),e.anchor.set(.5),e.zIndex=30,c.pet.isStatic=!0,e.alpha=c.score>0?1:.3,c.petEnd=e}if(c.score>0){if(a.target_versions&&g(),a.target_effect){b++;const e="te_"+b;let t=Unicorn.AddObject(e,{type:"circle",scale:{x:2,y:2},animations:{front:{framerate:4/60,frames:Array.from({length:a.target_effect.length},(e,t)=>"target_effect"+t),loop:!1,onComplete:()=>{Unicorn.RemoveObject(e)}}},isSensor:!0,isStatic:!0,x:c.player.position.x,y:c.player.position.y,z:200,radius:.1});t.isSensor=!0,t.animations.front.anchor.y=1}if(D&&a.target_versions[D].target_effect){b++;const e="te_"+b;let t=Unicorn.AddObject(e,{type:"circle",scale:{x:2,y:2},animations:{front:{framerate:4/60,frames:Array.from({length:a.target_versions[D].target_effect.length},(e,t)=>`target_effect${D}${t}`),loop:!1,onComplete:()=>{Unicorn.RemoveObject(e)}}},isSensor:!0,isStatic:!0,x:c.player.position.x,y:c.player.position.y,z:200,radius:.1});t.isSensor=!0,t.animations.front.anchor.y=1}if(a.target_animate_on_landed&&g(2),a.target_particles&&Y(a.target_particles[0],a.target_particles[1],c.player.position.x,c.player.position.y+40,10),a.target_boosh&&X(c.player.position.x,c.player.position.y+40),a.target_splash&&V(c.player.position.x,c.player.position.y+40),a.target_sound&&Unicorn.PlaySound("sfx-target-drop",{volume:n}),c.scoreLabel.x=c.label.position.x,c.scoreLabel.y=c.label.position.y-30,c.scoreLabel.text=c.score.toFixed(2),!l.startsWith("test_")){if(o.messageFormat){let e=o.messageFormat.replace("USERNAME",c.name).replace("POINTS",c.score.toFixed(2)).replace("SHORTPTS",Math.floor(c.score));setTimeout(()=>{ComfyJS.Say(e)},5e3)}y(c.name,c.score.toFixed(2),c.userId,l)}}c.score>R&&(R=c.score,B=l),c.label.alpha=c.score>0?1:.3,Unicorn.RemoveObject(c.player.label),Unicorn.RemoveBacklay("para_"+l),c.pet&&(Unicorn.RemoveObject(c.pet.label),Unicorn.RemoveBacklay("petpara_"+l))}else if(c.player.position.y>300){let t=Math.min(3,Math.max(0,.3*(c.player.position.y-300)));0===c.parachute.scale.x&&t>0&&Unicorn.PlaySound("sfx-parachute-flap",{volume:n}),c.parachute.visible=!0,c.pet&&(c.petPara.visible=!0),c.parachute.scale.x=c.parachute.scale.y=t,c.paraFlipDir&&c.player.velocity.x>0&&(c.parachute.scale.x=-t),c.parachute.rotation=Math.sin(c.player.rotationOffset+e/1e3)*Math.PI/16,c.player.angle=Math.sin(c.player.rotationOffset+e/1e3)*Math.PI/16,c.parachute.position.x=c.player.position.x,c.parachute.position.y=c.player.position.y-10-(a.parachute_offset||0)}else c.parachute.visible=!1,c.parachute.scale.x=c.parachute.scale.y=0,c.pet&&(c.petPara.visible=!1,c.petPara.scale.x=c.petPara.scale.y=0);c.label.position.x=c.player.position.x,c.label.position.y=c.player.position.y-60}}q.forEach((e,a)=>{e.x-=t*e.speed,e.x+e.width/2<=0&&(e.x=s+e.width/2,e.y=l(500),e.speed=.01+.1*Math.random(),e.zIndex=e.speed)}),G.forEach(e=>{(e.vY<0||e.y<i-5)&&(e.x+=t/1e3*e.vX,e.y+=t/1e3*e.vY,e.vY<20&&(e.vY+=t/1e3*200))}),N.forEach(e=>{(e.vY<0||e.y<i-5)&&(e.x+=t/1e3*e.vX,e.y+=t/1e3*e.vY,e.vY+=t/1e3*200)}),u>0&&(u-=t,u<=0&&(m&&clearInterval(m),Array.isArray(k)&&(k[C].visible=!1,C=0,k[C].visible=!0),T&&Array.isArray(T)&&(k[L].visible=!1,L=0,k[L].visible=!0)))}